<!DOCTYPE html>
<html>
<head>
  <title>Study Visit Feedback</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f9fafb;
      color: #333;
    }
    h2, h3, h4 { color: #00509e; }
    form {
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
      max-width: 900px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 95%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea { min-height: 60px; }
    .crc-section {
      background: #e9f3ff;
      border: 1px solid #bcd4f6;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }
    .team-wrapper {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    .team-section {
      flex: 2;
      background: #f0f9f0;
      border: 1px solid #c8e6c9;
      padding: 15px;
      border-radius: 8px;
      min-width: 280px;
    }
    .definitions-box {
      flex: 1;
      background: #fff8e1;
      border: 1px solid #ffecb3;
      padding: 15px;
      border-radius: 8px;
      font-size: 13px;
      min-width: 250px;
      max-width: 350px;
    }
    .definitions-box h4 {
      margin-top: 0;
      color: #c47f00;
    }
    .definitions-box strong {
      display: block;
      margin-top: 10px;
      color: #444;
    }
    .definitions-box ul {
      margin: 4px 0 10px 18px;
      padding: 0;
    }
    .definitions-box li {
      margin-bottom: 4px;
    }
    .inline-btn {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 5px;
    }
    .inline-btn input {
      flex: 1;
    }
    button {
      background-color: #00509e;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      margin-top: 10px;
    }
    button:hover { background-color: #003f7f; }
    #reportOutput {
      background: #ffffff;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.05);
    }
    #reportOutput strong { font-weight: bold; }
    .hidden { display: none; }  /* ensures the PDF button hides initially */
  </style>
  <!-- jsPDF 2.5.1 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <h2>Study Visit Feedback Form</h2>
  <form id="feedbackForm" onsubmit="return false;">
    <label>Supervisor: <input type="text" id="supervisor" required></label>
    <label>Start Date: <input type="date" id="startDate" required></label>
    <label>End Date: <input type="date" id="endDate" required></label>
    <label>Site Location: <input type="text" id="siteLocation" required></label>
    <label>PI:</label>
    <input type="text" id="piName" required>
    <label>Study Name: <input type="text" id="studyName" required></label>
    <label>Visit Number: <input type="text" id="visitNumber"></label>
    
    <label>Number of CRCs:</label>
    <div class="inline-btn">
      <input type="number" id="numCRCs" min="1" required>
      <button type="button" id="addCrcBtn">Add CRCs</button>
    </div>
    
    <div class="team-wrapper">
      <div class="team-section">
        <h3>Team Performance Feedback</h3>
        <label>Data Quality: <textarea id="teamDataQuality"></textarea></label>
        <label>Professionalism: <textarea id="teamProfessionalism"></textarea></label>
        <label>Preparedness / Training Compliance: <textarea id="teamPreparedness"></textarea></label>
      </div>
      <div class="definitions-box">
        <h4>Definitions</h4>
        <strong>Data Quality</strong>
        <ul>
          <li>Exhibit Good Clinical Practices (GCP) and Good Documentation Practices (GDP).</li>
          <li>Exhibit protocol compliance during study visit (measured in terms of protocol deviations).</li>
        </ul>
        <strong>Business Acumen & Professional Etiquette</strong>
        <ul>
          <li>Report on time in the clinic or hotel lobby as assigned by the Supervisor.</li>
          <li>Limit cell phone usage to breaks (no social media/personal tasks during study visits).</li>
          <li>Adhere to clinic dress code: Ora scrubs, appropriate inner/outer layers, closed-toed shoes.</li>
          <li>Avoid: non-Ora scrubs, bright inner layers, sweatshirts/hoodies, crocs or unprofessional attire.</li>
        </ul>
        <strong>Study Preparedness & Training Compliance</strong>
        <ul>
          <li>Complete study-specific training ahead of the study visit.</li>
          <li>Obtain access to study database ahead of the study visit.</li>
        </ul>
      </div>
    </div>
    
    <div id="crcContainer"></div>
    
    <h3>Site Feedback</h3>
    <label>Site Comments: <textarea id="siteComments"></textarea></label>
    
    <h3>Additional Comments</h3>
    <label><textarea id="additionalComments" placeholder="Any other feedback..."></textarea></label>
    
    <button type="button" onclick="generateReport()">Generate Report</button>
  </form>

  <h2>Report</h2>
  <div id="reportOutput"></div>
  <button id="downloadBtn" class="hidden" onclick="downloadPDF()">Email & Download PDF</button>

  <script>
    // ---------- CRC Button ----------
    document.getElementById("addCrcBtn").addEventListener("click", generateCRCs);

    // ---------- Date helpers (timezone-safe: parse as LOCAL, not UTC) ----------
    function parseDateLocal(yyyy_mm_dd) {
      // Expect "YYYY-MM-DD" (from <input type="date">). Parse without timezone.
      if (!yyyy_mm_dd) return null;
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(yyyy_mm_dd);
      if (!m) return null;
      const [_, y, mo, d] = m;
      return new Date(Number(y), Number(mo) - 1, Number(d)); // local midnight
    }

    function formatDate(dateStr) {
      const d = parseDateLocal(dateStr);
      if (!d) return "";
      const day = String(d.getDate()).padStart(2, '0');
      const month = d.toLocaleString('en-US', { month: 'short' });
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function formatDateRange(startStr, endStr) {
      const start = formatDate(startStr);
      const end = formatDate(endStr);
      if (!start && !end) return "";
      if (start === end || !end) return start;
      return `${start} to ${end}`;
    }

    // For EmailJS filename date (YYYY-MM-DD)
    function toISODate(dateStr) {
      const d = parseDateLocal(dateStr) || new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Build a subject-safe date range (no slashes)
    function subjectDateRange(startStr, endStr) {
      const pretty = formatDateRange(startStr, endStr);        // e.g., 23/Sep/2025 to 25/Sep/2025
      return pretty.replace(/\//g, "-");                       // -> 23-Sep-2025 to 25-Sep-2025
    }

    // ---------- CRC dynamic fields ----------
    function generateCRCs() {
      const container = document.getElementById("crcContainer");
      container.innerHTML = "";
      const num = parseInt(document.getElementById("numCRCs").value);
      if (!num || num < 1) return;
      
      for (let i = 1; i <= num; i++) {
        container.insertAdjacentHTML("beforeend", `
          <div class="crc-section">
            <h4>CRC ${i}</h4>
            <label>Name: <input type="text" id="crcName${i}" required></label>
            <label>Role: <input type="text" id="crcRole${i}" required></label>
            <label>Comments: <textarea id="crcComments${i}"></textarea></label>
            
            <label>Protocol Deviations? 
              <select id="crcDeviation${i}" onchange="toggleDeviationField(${i})">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </label>
            <label id="deviationLabel${i}" style="display:none;">
              Describe Deviations: <em>(type of deviation, cause of deviation and any corrective action taken)</em><br>
              <textarea id="crcDeviationText${i}"></textarea>
            </label>
          </div>`);
      }
    }

    function toggleDeviationField(i) {
      const select = document.getElementById(`crcDeviation${i}`);
      const label = document.getElementById(`deviationLabel${i}`);
      if (select.value === "Yes") {
        label.style.display = "block";
      } else {
        label.style.display = "none";
        document.getElementById(`crcDeviationText${i}`).value = "";
      }
    }

    // ---------- Report preview ----------
    function generateReport() {
      let reportHTML = `<strong>Supervisor:</strong> ${document.getElementById("supervisor").value}<br>`;
      reportHTML += `<strong>Date:</strong> ${formatDateRange(document.getElementById("startDate").value, document.getElementById("endDate").value)}<br>`;
      reportHTML += `<strong>Site:</strong> ${document.getElementById("siteLocation").value}<br>`;
      reportHTML += `<strong>PI:</strong> ${document.getElementById("piName").value}<br>`;
      reportHTML += `<strong>Study:</strong> ${document.getElementById("studyName").value}<br>`;
      if (document.getElementById("visitNumber").value) {
        reportHTML += `<strong>Visit #:</strong> ${document.getElementById("visitNumber").value}<br>`;
      }
      reportHTML += `<br><strong>Team Performance Feedback</strong><br>`;
      reportHTML += `Data Quality: ${document.getElementById("teamDataQuality").value}<br>`;
      reportHTML += `Professionalism: ${document.getElementById("teamProfessionalism").value}<br>`;
      reportHTML += `Preparedness / Training Compliance: ${document.getElementById("teamPreparedness").value}<br><br>`;

      const num = parseInt(document.getElementById("numCRCs").value);
      for (let i = 1; i <= num; i++) {
        const name = document.getElementById("crcName"+i).value || `CRC ${i}`;
        reportHTML += `<strong>${name}</strong><br>`;
        reportHTML += `Role: ${document.getElementById("crcRole"+i).value}<br>`;
        reportHTML += `Comments: ${document.getElementById("crcComments"+i).value}<br>`;
        const deviation = document.getElementById("crcDeviation"+i).value;
        reportHTML += `Protocol Deviations: ${deviation}<br>`;
        if (deviation === "Yes") {
          reportHTML += `Deviation Details: ${document.getElementById("crcDeviationText"+i).value}<br>`;
        }
        reportHTML += `<br>`;
      }

      reportHTML += `<strong>Site Comments:</strong> ${document.getElementById("siteComments").value}<br><br>`;
      reportHTML += `<strong>Additional Comments:</strong> ${document.getElementById("additionalComments").value}<br>`;

      document.getElementById("reportOutput").innerHTML = reportHTML;
      document.getElementById("downloadBtn").classList.remove("hidden");
    }

    // ---------- EmailJS (with subject-safe range) ----------
    const EMAIL_TO = "recipient@example.com"; // <- set the recipient you want
    emailjs.init({ publicKey: "XrSFri5K-8boAX6f9" });
    const EMAILJS_SERVICE_ID  = "service_yfhb0eo";
    const EMAILJS_TEMPLATE_ID = "template_zduciok";

    async function emailjs_sendAndSave(doc, filename) {
      // Build dynamic values from the form (using local-date helpers)
      const supervisor = document.getElementById("supervisor").value || "";
      const site       = document.getElementById("siteLocation").value || "";
      const pi         = document.getElementById("piName").value || "";
      const study      = document.getElementById("studyName").value || "";
      const visit      = document.getElementById("visitNumber").value || "";

      const startVal = document.getElementById("startDate").value;
      const endVal   = document.getElementById("endDate").value;

      const dateRangePretty   = formatDateRange(startVal, endVal) || "";
      const dateRangeForTitle = subjectDateRange(startVal, endVal) || "";
      const isoDateForFilename = toISODate(startVal);

      // Subject uses the hyphenated range to avoid HTML-escaped slashes
      const subject = `Feedback - ${study}${visit ? " V" + visit : ""} - ${site} - ${dateRangeForTitle}`;

      // PDF as base64 data URL
      const dataUrl = doc.output("datauristring");

      // Params sent to EmailJS (names must match your template placeholders)
      const params = {
        to_email: EMAIL_TO,
        subject: subject,                  // if your template's Subject is {{subject}}, this will be used
        message: "Attached is the Study Visit Feedback PDF.",
        date: isoDateForFilename,          // used by Study_Visit_{{date}}.pdf in attachments

        // Dynamic fields for the email template body:
        supervisor: supervisor,
        study: study,
        site: site,
        visit: visit,
        pi: pi,
        date_range: dateRangePretty,       // body keeps slashes, looks nice

        // Extra: subject-safe date range if you want to build subject inside template
        subject_date_range: dateRangeForTitle,

        // Attachment
        pdf_data: dataUrl
      };

      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
        doc.save(filename);
        alert("PDF emailed successfully!");
      } catch (err) {
        console.error("EmailJS send error:", err);
        alert("Email failed — downloading locally anyway.");
        doc.save(filename);
      }
    }

    // ---- PDF generator (original content; final line patched) ----
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const margin = 15;
      const topMargin = 28;
      const bottomMargin = 15;
      const lineHeight = 6.5;
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const textW = pageW - margin * 2;
      let y = topMargin;

      // Colored header
      doc.setFillColor(0, 80, 158);
      doc.rect(0, 0, pageW, 20, "F");
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Study Visit Feedback", margin, 12);
      doc.setTextColor(0, 0, 0);

      function addPageIfNeeded(lines = 1) {
        if (y + lines * lineHeight > pageH - bottomMargin) {
          doc.addPage();
          y = topMargin;
        }
      }

      function printKV(label, value, indent = 0) {
        if (!value && value !== 0) return;
        const labelText = label ? label + ":" : "";
        doc.setFontSize(11);
        const xLabel = margin + indent;

        if (labelText) {
          doc.setFont("helvetica", "bold");
          const labelWidth = doc.getTextWidth(labelText);
          const xValue = xLabel + labelWidth + 3;
          const maxLabelWidth = textW * 0.45;

          if (labelWidth > maxLabelWidth || xValue > margin + textW - 10) {
            // Long label → value on next line
            const labelLines = doc.splitTextToSize(labelText, textW - indent);
            addPageIfNeeded(labelLines.length);
            doc.text(labelLines, xLabel, y);
            y += labelLines.length * lineHeight;

            doc.setFont("helvetica", "normal");
            const valueLines = doc.splitTextToSize(String(value), textW - indent - 6);
            addPageIfNeeded(valueLines.length);
            doc.text(valueLines, xLabel + 6, y);
            y += valueLines.length * lineHeight;
          } else {
            // Same line
            addPageIfNeeded(1);
            doc.text(labelText, xLabel, y);
            doc.setFont("helvetica", "normal");
            const vLines = doc.splitTextToSize(String(value), textW - (xValue - margin));
            doc.text(vLines[0], xValue, y);
            for (let i = 1; i < vLines.length; i++) {
              y += lineHeight;
              addPageIfNeeded(1);
              doc.text(vLines[i], xValue, y);
            }
            y += lineHeight;
          }
        } else {
          // No label (used for section body blocks)
          doc.setFont("helvetica", "normal");
          const lines = doc.splitTextToSize(String(value), textW - indent);
          addPageIfNeeded(lines.length);
          doc.text(lines, xLabel, y);
          y += lines.length * lineHeight;
        }
      }

      function printSectionTitle(text, underline = false) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        const lines = doc.splitTextToSize(text, textW);
        addPageIfNeeded(lines.length);
        doc.text(lines, margin, y);
        if (underline) {
          const lineW = doc.getTextWidth(text);
          doc.setLineWidth(0.5);
          doc.line(margin, y + 1, margin + lineW, y + 1);
        }
        y += lines.length * lineHeight;
      }

      function gap(mult = 1) { y += lineHeight * mult; }

      // Body summary
      printKV("Supervisor", document.getElementById("supervisor").value);
      printKV("Date", formatDateRange(document.getElementById("startDate").value, document.getElementById("endDate").value));
      printKV("Site", document.getElementById("siteLocation").value);
      printKV("PI", document.getElementById("piName").value);
      printKV("Study", document.getElementById("studyName").value);
      if (document.getElementById("visitNumber").value) {
        printKV("Visit #", document.getElementById("visitNumber").value);
      }

      gap(0.5);
      printSectionTitle("Team Performance Feedback", true);
      printKV("Data Quality", document.getElementById("teamDataQuality").value, 4);
      printKV("Professionalism", document.getElementById("teamProfessionalism").value, 4);
      printKV("Preparedness / Training Compliance", document.getElementById("teamPreparedness").value, 4);

      // CRCs
      const num = parseInt(document.getElementById("numCRCs").value || "0", 10);
      for (let i = 1; i <= num; i++) {
        gap(0.5);
        const name = document.getElementById("crcName"+i).value || `CRC ${i}`;
        printSectionTitle(name, true);
        printKV("Role", document.getElementById("crcRole"+i).value, 4);
        printKV("Comments", document.getElementById("crcComments"+i).value, 4);
        const deviation = document.getElementById("crcDeviation"+i).value;
        printKV("Protocol Deviations", deviation, 4);
        if (deviation === "Yes") {
          printKV("Deviation Details", document.getElementById("crcDeviationText"+i).value, 4);
        }
      }

      gap(0.5);
      printSectionTitle("Site Comments", true);
      printKV("", document.getElementById("siteComments").value);
      gap(0.5);
      printSectionTitle("Additional Comments", true);
      printKV("", document.getElementById("additionalComments").value);

      // Filename
      const start = formatDate(document.getElementById("startDate").value) || "NoStart";
      const end = formatDate(document.getElementById("endDate").value) || "NoEnd";
      const site = (document.getElementById("siteLocation").value || "NoSite").replace(/\s+/g, "_");
      const study = (document.getElementById("studyName").value || "NoStudy").replace(/\s+/g, "_");
      const filename = (start === end || !end) 
        ? `Feedback_${start}_${site}_${study}.pdf`
        : `Feedback_${start}_to_${end}_${site}_${study}.pdf`;

      // Email via EmailJS with dynamic fields, then save locally
      await emailjs_sendAndSave(doc, filename);
    }
  </script>
</body>
</html>
